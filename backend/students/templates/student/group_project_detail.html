{% extends '../base.html' %}

{% block title %}{{ project.title }} | {{ group.name }} | TISD{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <a href="{% url 'group_detail' group.id %}" class="text-text-secondary hover:text-white flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            Back to Group
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Project Info -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Project Header -->
            <div class="bg-card border border-card-border rounded-xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <h1 class="text-2xl font-bold text-white">{{ project.title }}</h1>
                    {% if is_leader %}
                    <div class="flex gap-2">
                        <a href="{% url 'edit_group_project' group.id project.id %}" class="text-primary hover:text-primary-hover">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    {% if project.tech_stack %}
                    <span class="bg-primary-light text-primary text-sm px-3 py-1 rounded-full">{{ project.tech_stack }}</span>
                    {% endif %}
                    {% if project.sdgs %}
                    <span class="bg-primary-light text-primary text-sm px-3 py-1 rounded-full">SDGs: {{ project.sdgs }}</span>
                    {% endif %}
                    <span class="bg-primary-light text-primary text-sm px-3 py-1 rounded-full">{{ project.status|title }}</span>
                </div>
                
                <p class="text-text-secondary mb-6">{{ project.description }}</p>
                
                {% if project.github_link %}
                <div class="mb-4">
                    <a href="{{ project.github_link }}" target="_blank" class="text-primary hover:text-primary-hover flex items-center gap-2">
                        <i class="fab fa-github"></i>
                        View on GitHub
                    </a>
                </div>
                {% endif %}
                
                <!-- Project Images -->
                {% if project.project_image1 or project.project_image2 or project.project_image3 or project.project_image4 or project.project_image5 %}
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6">
                    {% if project.project_image1 %}
                    <img src="{{ project.project_image1.url }}" alt="Project Image 1" class="rounded-lg h-40 w-full object-cover">
                    {% endif %}
                    {% if project.project_image2 %}
                    <img src="{{ project.project_image2.url }}" alt="Project Image 2" class="rounded-lg h-40 w-full object-cover">
                    {% endif %}
                    {% if project.project_image3 %}
                    <img src="{{ project.project_image3.url }}" alt="Project Image 3" class="rounded-lg h-40 w-full object-cover">
                    {% endif %}
                    {% if project.project_image4 %}
                    <img src="{{ project.project_image4.url }}" alt="Project Image 4" class="rounded-lg h-40 w-full object-cover">
                    {% endif %}
                    {% if project.project_image5 %}
                    <img src="{{ project.project_image5.url }}" alt="Project Image 5" class="rounded-lg h-40 w-full object-cover">
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- Meetings Section -->
            <div class="bg-card border border-card-border rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Meetings</h2>
                    {% if project.is_open_for_collaboration and collaborators %}
                    <a href="{% url 'student_schedule_meeting' project.id collaborators.0.collaborator.id %}" class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Schedule Meeting
                    </a>
                    {% endif %}
                </div>
                
                {% if meetings %}
                <div class="space-y-4">
                    {% for meeting in meetings %}
                    <div class="bg-black bg-opacity-30 border border-card-border rounded-lg p-4 hover:border-primary transition-all">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-medium text-white mb-1">{{ meeting.meeting_title }}</h3>
                                <p class="text-text-secondary mb-2">{{ meeting.meeting_description }}</p>
                                <div class="flex items-center gap-2 text-text-secondary text-sm">
                                    <i class="fas fa-calendar-alt"></i>
                                    {{ meeting.scheduled_time|date:"M d, Y H:i" }}
                                    <i class="fas fa-clock ml-2"></i>
                                    {{ meeting.duration }} mins
                                </div>
                            </div>
                            <div>
                                <span class="px-3 py-1 rounded-full text-sm 
                                    {% if meeting.status == 'scheduled' %}bg-blue-500 text-white
                                    {% elif meeting.status == 'completed' %}bg-green-500 text-white
                                    {% else %}bg-red-500 text-white{% endif %}">
                                    {{ meeting.status|title }}
                                </span>
                            </div>
                        </div>
                        {% if meeting.zoom_link %}
                        <div class="mt-3">
                            <a href="{{ meeting.zoom_link }}" target="_blank" class="text-primary hover:text-primary-hover flex items-center gap-2">
                                <i class="fas fa-video"></i>
                                Join Zoom Meeting
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="text-6xl mb-4 text-text-secondary">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">No Meetings Scheduled</h3>
                    <p class="text-text-secondary">Schedule a meeting with your collaborators to discuss the project.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Comments Section -->
            <div class="bg-card border border-card-border rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Discussion</h2>
                
                <!-- Comment Form -->
                <form method="post" action="{% url 'add_project_comment' project.id %}" class="mb-6">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea name="content" rows="3" class="w-full bg-black bg-opacity-30 border border-card-border text-white rounded-lg px-4 py-3 focus:outline-none focus:border-primary" placeholder="Add a comment..."></textarea>
                    </div>
                    <button type="submit" class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-lg">
                        Post Comment
                    </button>
                </form>
                
                <!-- Comments List -->
                <div class="space-y-6">
                    {% for comment in comments %}
                    <div class="border-b border-card-border pb-6 last:border-0 last:pb-0">
                        <div class="flex items-start gap-3 mb-3">
                            {% if comment.author_student %}
                                {% if comment.author_student.profile_picture %}
                                <img src="{{ comment.author_student.profile_picture.url }}" alt="{{ comment.author_student.full_name }}" class="w-10 h-10 rounded-full">
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-primary-light flex items-center justify-center">
                                    <i class="fas fa-user text-primary"></i>
                                </div>
                                {% endif %}
                            {% else %}
                                {% if comment.author_collaborator.profile_picture %}
                                <img src="{{ comment.author_collaborator.profile_picture.url }}" alt="{{ comment.author_collaborator.full_name }}" class="w-10 h-10 rounded-full">
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-primary-light flex items-center justify-center">
                                    <i class="fas fa-user text-primary"></i>
                                </div>
                                {% endif %}
                            {% endif %}
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-medium text-white">{{ comment.get_author_name }}</h4>
                                    <span class="text-xs text-text-secondary">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <p class="text-text-secondary mt-1">{{ comment.content }}</p>
                                
                                <!-- Reply Form (toggle with button) -->
                                <button onclick="toggleReplyForm('reply-form-{{ comment.id }}')" class="text-sm text-primary hover:text-primary-hover mt-2">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                                
                                <form id="reply-form-{{ comment.id }}" method="post" action="{% url 'add_project_comment' project.id %}" class="hidden mt-3">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                                    <div class="flex gap-2">
                                        <textarea name="content" rows="2" class="flex-1 bg-black bg-opacity-30 border border-card-border text-white rounded-lg px-4 py-2 focus:outline-none focus:border-primary" placeholder="Write a reply..."></textarea>
                                        <button type="submit" class="bg-primary hover:bg-primary-hover text-white px-3 py-2 rounded-lg h-fit">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Replies -->
                        {% if comment.replies.all %}
                        <div class="ml-12 mt-4 space-y-4 border-l-2 border-card-border pl-4">
                            {% for reply in comment.replies.all %}
                            <div class="flex items-start gap-3">
                                {% if reply.author_student %}
                                    {% if reply.author_student.profile_picture %}
                                    <img src="{{ reply.author_student.profile_picture.url }}" alt="{{ reply.author_student.full_name }}" class="w-8 h-8 rounded-full">
                                    {% else %}
                                    <div class="w-8 h-8 rounded-full bg-primary-light flex items-center justify-center">
                                        <i class="fas fa-user text-primary text-sm"></i>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    {% if reply.author_collaborator.profile_picture %}
                                    <img src="{{ reply.author_collaborator.profile_picture.url }}" alt="{{ reply.author_collaborator.full_name }}" class="w-8 h-8 rounded-full">
                                    {% else %}
                                    <div class="w-8 h-8 rounded-full bg-primary-light flex items-center justify-center">
                                        <i class="fas fa-user text-primary text-sm"></i>
                                    </div>
                                    {% endif %}
                                {% endif %}
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h4 class="text-sm font-medium text-white">{{ reply.get_author_name }}</h4>
                                        <span class="text-xs text-text-secondary">{{ reply.created_at|timesince }} ago</span>
                                    </div>
                                    <p class="text-sm text-text-secondary mt-1">{{ reply.content }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4 text-text-secondary">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">No Comments Yet</h3>
                        <p class="text-text-secondary">Start the discussion by adding the first comment.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Project Status -->
            <div class="bg-card border border-card-border rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Project Status</h2>
                <div class="space-y-3">
                    <div>
                        <p class="text-text-secondary text-sm">Current Phase</p>
                        <p class="text-white font-medium">{{ project.status|title }}</p>
                    </div>
                    {% if project.mentor %}
                    <div>
                        <p class="text-text-secondary text-sm">Mentor</p>
                        <p class="text-white font-medium">{{ project.mentor.full_name }}</p>
                    </div>
                    {% endif %}
                    {% if project.mentor_feedback %}
                    <div>
                        <p class="text-text-secondary text-sm">Mentor Feedback</p>
                        <p class="text-white">{{ project.mentor_feedback }}</p>
                    </div>
                    {% endif %}
                    {% if project.mentor_grade %}
                    <div>
                        <p class="text-text-secondary text-sm">Grade</p>
                        <p class="text-white font-medium">{{ project.mentor_grade }}/100</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Mentors -->
            {% if mentors %}
            <div class="bg-card border border-card-border rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Your Mentors</h2>
                <div class="space-y-4">
                    {% for mentor in mentors %}
                    <div class="flex items-center gap-3">
                        {% if mentor.mentor.profile_picture %}
                        <img src="{{ mentor.mentor.profile_picture.url }}" alt="{{ mentor.mentor.full_name }}" class="w-10 h-10 rounded-full">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-primary-light flex items-center justify-center">
                            <i class="fas fa-user-tie text-primary"></i>
                        </div>
                        {% endif %}
                        <div>
                            <p class="text-white font-medium">{{ mentor.mentor.full_name }}</p>
                            <p class="text-text-secondary text-sm">Mentor</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Collaborators -->
            {% if collaborators %}
            <div class="bg-card border border-card-border rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Collaborators</h2>
                <div class="space-y-4">
                    {% for collab in collaborators %}
                    <div class="flex items-center gap-3">
                        {% if collab.collaborator.profile_picture %}
                        <img src="{{ collab.collaborator.profile_picture.url }}" alt="{{ collab.collaborator.full_name }}" class="w-10 h-10 rounded-full">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-primary-light flex items-center justify-center">
                            <i class="fas fa-user-shield text-primary"></i>
                        </div>
                        {% endif %}
                        <div>
                            <p class="text-white font-medium">{{ collab.collaborator.full_name }}</p>
                            <p class="text-text-secondary text-sm">Collaborator</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Collaboration Status -->
            <div class="bg-card border border-card-border rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Collaboration</h2>
                <div class="flex items-center justify-between mb-3">
                    <span class="text-text-secondary">Status</span>
                    <span class="px-3 py-1 rounded-full text-sm {% if project.is_open_for_collaboration %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                        {% if project.is_open_for_collaboration %}Open{% else %}Closed{% endif %}
                    </span>
                </div>
                {% if is_leader %}
                <form method="post" action="{% url 'toggle_project_collaboration' project.id %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full text-center {% if project.is_open_for_collaboration %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white px-4 py-2 rounded-lg transition-colors">
                        {% if project.is_open_for_collaboration %}
                            Close Collaboration
                        {% else %}
                            Open for Collaboration
                        {% endif %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function toggleReplyForm(formId) {
        const form = document.getElementById(formId);
        form.classList.toggle('hidden');
    }
</script>
{% endblock %}